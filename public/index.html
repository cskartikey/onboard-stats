<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnBoard Repository Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                text-align: center;
                margin: 0;
                padding: 0;
                background-color: #f4f4f4;
            }
            .chart-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                padding: 20px;
            }
            .chart-item {
                flex: 1 1 100%;
                max-width: 100%;
                padding: 10px;
                box-sizing: border-box;
            }
            @media (min-width: 768px) {
                .chart-item {
                    flex: 1 1 45%;
                }
            }
            @media (min-width: 1024px) {
                .chart-item {
                    flex: 1 1 30%;
                }
            }
            canvas {
                width: 100% !important;
                height: 400px !important;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
        </style>
    </head>
    <body>
        <h1>OnBoard Repository Statistics</h1>
        <div class="chart-container">
            <div class="chart-item">
                <canvas id="projectsChart"></canvas>
            </div>
            <div class="chart-item">
                <canvas id="pullRequestsChart"></canvas>
            </div>
        </div>
    <script>
        async function fetchData() {
            try {
                const response = await fetch('/data');
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                const data = await response.json();
                console.log('Fetched data:', data);
                return data;
            } catch (error) {
                console.error('Fetch data failed:', error);
                return null;
            }
        }

        function renderChart(ctx, labels, data, type, title, unit, colors) {
            console.log('Rendering chart:', title);
            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.background,
                        borderColor: colors.border,
                        borderWidth: 2,
                        pointBackgroundColor: colors.pointBackground,
                        pointBorderColor: colors.pointBorder,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.raw;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: title,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: unit,
                                tooltipFormat: 'll',
                                displayFormats: {
                                    month: 'MMM YYYY'
                                }
                            },
                            adapters: {
                                date: {
                                    locale: moment.locale()
                                }
                            },
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        async function main() {
            const data = await fetchData();
            if (!data) {
                console.log('No data fetched');
                return;
            }

            const projectsData = Object.values(data.projects).sort((a, b) => new Date(a.date) - new Date(b.date));
            const pullRequestsData = Object.entries(data.pull_requests).sort((a, b) => new Date(a[0]) - new Date(b[0]));

            console.log('Processed projectsData:', projectsData);
            console.log('Processed pullRequestsData:', pullRequestsData);

            const filteredProjectsData = projectsData.filter(entry => entry.subdirsCount > 0);
            const filteredPullRequestsData = pullRequestsData.filter(entry => entry[1] > 0);

            const projectDates = filteredProjectsData.map(entry => new Date(entry.date));
            const projectCounts = filteredProjectsData.map(entry => entry.subdirsCount);
            const prDates = filteredPullRequestsData.map(entry => new Date(entry[0]));
            const prCounts = filteredPullRequestsData.map(entry => entry[1]);

            console.log('Filtered projectDates:', projectDates);
            console.log('Filtered projectCounts:', projectCounts);
            console.log('Filtered prDates:', prDates);
            console.log('Filtered prCounts:', prCounts);

            const totalGrants = projectCounts[projectCounts.length - 1];
            const totalOpenPRs = prCounts[prCounts.length - 1];

            console.log('Total grants:', totalGrants);
            console.log('Total open PRs:', totalOpenPRs);

            const projectsCtx = document.getElementById('projectsChart').getContext('2d');
            renderChart(projectsCtx, projectDates, projectCounts, 'line', `Number of Funded Projects Over Time (Total number of grants given = ${totalGrants})`, 'month', {
                background: 'rgba(75, 192, 192, 0.2)',
                border: 'rgba(75, 192, 192, 1)',
                pointBackground: 'rgba(75, 192, 192, 1)',
                pointBorder: 'rgba(75, 192, 192, 1)'
            });

            const prCtx = document.getElementById('pullRequestsChart').getContext('2d');
            renderChart(prCtx, prDates, prCounts, 'bar', `Number of Open Pull Requests Over Time (Total number of open PRs = ${totalOpenPRs})`, 'day', {
                background: 'rgba(153, 102, 255, 0.2)',
                border: 'rgba(153, 102, 255, 1)',
                pointBackground: 'rgba(153, 102, 255, 1)',
                pointBorder: 'rgba(153, 102, 255, 1)'
            });

        }

        main();
    </script>
</body>
</html>
